#!/bin/sh

SED="$(which sed)"
AWK="$(which awk)"

DOCKERHOST="$(printf "%d." $(
  echo $($AWK '$2 == "00000000" {print $3}' /proc/net/route) | $SED 's/../0x& /g' | tr ' ' '\n' | tac
  ) | $SED 's/\.$/\n/')"

exec consul-template \
     -consul=$DOCKERHOST:8500 \
     -template "/etc/consul-templates/nginx.conf:/etc/nginx/conf.d/app.conf:sv hup nginx"
